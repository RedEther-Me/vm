import {
  CPU,
  MemoryController,
  createMemory,
  BOOT_ADDRESS,
} from "@emulator/core";

const bios =
  "00000000100000000000000110101011000000000100001000000000011000010000000001110011000000000110100100000000011000110000000001001111000000000101001100000000001000000000000000110000000000000010111000000000001100010000000000001010000000000000000000000000010101110000000001100001000000000110100100000000011101000000000001101001000000000110111000000000011001110000000000100000000000000110011000000000011011110000000001110010000000000010000000000000010000010000000001110000000000000111000000000000011011000000000001101001000000000110001100000000011000010000000001110100000000000110100100000000011011110000000001101110000000000010000000000000011101000000000001101111000000000010000000000000011011000000000001101111000000000110000100000000011001000000000000100000000000000110000100000000011101000000000000100000000000000011000000000000011110000000000000111000000000000011000000000000001100000000000000110000000000000010000000000000000010100000000000000000111100000000000010101110000000010010000000000000000011100010001000000010001000010000000000000001000100000000000101010011000000010010000000000000001010000010001000000010001000010000000000000001000100000000000101010011010000000011000010000000000000000110110100110000000000000000000000010110000000001001101100000001110000001000000000000000000100001000000000000000000000000110110111010000000000000000001000010101000000001011110100100010000011100010000100000000000000010001000000000001010100110110110111010000000000000000001100010101000000001100110000100010000011100010000100000000000000010001000000000000110101010001001100000000000000000000000000000000000000000101000000110000000000000000001000011011011000110001000000000000000110000110001100010000000000000000001001000001001000010100001001000000000000001100110101000010010100000000000011001111010000100111000000000000110100110100001010000000000000001101000100000001100100000000000000000001000000101001100001100110100001000110000010000111011000001000010100000010001100101000000100110000000000000000111101101101001100001111111111111111000101010000000100010010001100111000000000000000001011010110000110000000000000000000000100000010010100100110000001010011100010000011010100000001011000000000000000000000011000010110000000000000000000010000001000100011011010010011000000000000000010100010001000000001011011010011000000000000000000000001010100000001000111000010001100000011011000010011000000000000001100000011000110000011011000011000000000000000000000010110010101100000000000000000000101101101011000000000000000000000000101010000000100101111011001001000011101101000100010010011010000000001000000001100111100110100000010000000000011001101000100110000001000011011011000110001000000000000000110000110001100010000000000000000001001000001001100010100001001000000000000001100110101000010010100000000000011001111010000100111000000000000110100110100001010000000000000001101000100000001100100000000000000000001000000100110100001100110100001000110000010000111011000001000010101000001001000110110110100100000000000000000000000010110000000011010100001101101001000000000000000001010000101010000000110011011000000100100100001100100010001110110100001000110000000100100011001100100010000010110000010000100011001011000000000000000000000010101000110000011011000010011000000000000000000100110000110000000000000000000000100010111000000010111101101100100100001110110100010000110001101000000000100000000110011110011010000001000000000001100110100010011";

let machine;

const loadMedia = (file) => {
  const lines = file.match(/.{1,8}/g);

  lines.forEach((line, index) => {
    machine.mm.setUint8(BOOT_ADDRESS + index, parseInt(line, 2));
  });

  machine.cpu.reset();
};

// Initialize Machine
(() => {
  if (!machine) {
    const memory = createMemory(256 * 256);

    const mm = new MemoryController({
      listener: (data) => {
        console.log(data);
        process.send(data);
      },
    });
    mm.map("memory", memory, 0, 0xffff);

    const cpu = new CPU(mm, { logger: console });
    cpu.addListener("program", (data) => {
      process.send(data);
    });

    machine = {
      cpu,
      mm,
    };
  }
})();

process.on("message", ({ event, ...args }) => {
  console.log("--->", event);
  switch (event) {
    case "step": {
      machine.cpu.step();
      break;
    }
    case "run": {
      machine.cpu.run();
      break;
    }
    case "reset": {
      machine.cpu.reset();
      loadMedia(bios);
      break;
    }
    case "register-device": {
      const { name, from, to } = args;
      machine.mm.map(
        name,
        {
          getUint16: () => 0,
          getUint8: () => 0,
          setUint16: (address, data) => {
            process.send({ event: name, method: "setUint16", address, data });
          },
        },
        from,
        to
      );
      break;
    }
    default:
      break;
  }
});
